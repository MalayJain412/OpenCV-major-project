<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionTrack - Real-Time Human Pose Estimation</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            max-width: 100%;
            background: #000;
        }
        .video-feed {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .mode-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .exercise-active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .coming-soon {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #8b4513;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-indigo-500">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-eye text-3xl text-indigo-600"></i>
                    <h1 class="text-3xl font-bold text-gray-800">VisionTrack</h1>
                    <span class="text-sm text-gray-500 bg-gray-200 px-2 py-1 rounded">Real-Time Pose Estimation</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="status-indicator" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-600">Disconnected</span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Video Feed Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-video mr-2"></i>Live Feed
                        </h2>
                        <div class="flex space-x-2">
                            <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-play mr-1"></i>Start
                            </button>
                            <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-stop mr-1"></i>Stop
                            </button>
                            <button id="reset-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-refresh mr-1"></i>Reset
                            </button>
                            <button id="save-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-save mr-1"></i>Save
                            </button>
                            <button id="audio-toggle-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
                                <i class="fas fa-volume-up mr-1"></i><span id="audio-status">Audio</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="video-container">
                        <img id="video-feed" src="/video_feed" alt="Video Feed" class="video-feed">
                        <div id="video-overlay" class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded">
                            <span id="current-mode" class="font-semibold">FITNESS MODE</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="space-y-6">
                
                <!-- Mode Selection -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-cogs mr-2"></i>Mode Selection
                    </h3>
                    <div class="space-y-3">
                        <button id="mode-fitness" class="mode-btn mode-active w-full p-3 rounded-lg text-left transition">
                            <i class="fas fa-dumbbell mr-2"></i>
                            <span class="font-semibold">Fitness Mode</span>
                            <p class="text-sm opacity-80 mt-1">Workout tracking & form analysis</p>
                        </button>
                        <button id="mode-surveillance" class="mode-btn w-full p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 transition">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span class="font-semibold">Surveillance Mode</span>
                            <p class="text-sm opacity-80 mt-1">Movement tracking & alerts</p>
                        </button>
                        <button id="mode-gaming" class="mode-btn w-full p-3 rounded-lg text-left coming-soon transition">
                            <i class="fas fa-gamepad mr-2"></i>
                            <span class="font-semibold">Gaming Mode</span>
                            <p class="text-sm opacity-80 mt-1">Coming Soon! Interactive games</p>
                        </button>
                    </div>
                </div>

                <!-- Exercise Selection (for Fitness Mode) -->
                <div id="exercise-selection" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-dumbbell mr-2"></i>Exercise Type
                    </h3>
                    <div class="space-y-3">
                        <button id="exercise-squat" class="exercise-btn exercise-active w-full p-3 rounded-lg text-left transition">
                            <i class="fas fa-arrow-down mr-2"></i>
                            <span class="font-semibold">Squats</span>
                            <p class="text-sm opacity-80 mt-1">Lower body strength training</p>
                        </button>
                        <button id="exercise-pushup" class="exercise-btn w-full p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 transition">
                            <i class="fas fa-hand-paper mr-2"></i>
                            <span class="font-semibold">Push-ups</span>
                            <p class="text-sm opacity-80 mt-1">Upper body strength training</p>
                        </button>
                        <button id="exercise-bicep" class="exercise-btn w-full p-3 rounded-lg text-left bg-gray-100 hover:bg-gray-200 transition">
                            <i class="fas fa-fist-raised mr-2"></i>
                            <span class="font-semibold">Bicep Curls</span>
                            <p class="text-sm opacity-80 mt-1">Arm muscle development</p>
                        </button>
                    </div>
                </div>

                <!-- Real-time Stats -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Live Statistics
                    </h3>
                    <div class="space-y-4">
                        <div class="stats-card p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm opacity-80">FPS</span>
                                <span id="fps-value" class="text-xl font-bold">0</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm opacity-80">Active People</span>
                                <span id="people-value" class="text-xl font-bold">0</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm opacity-80">Session Reps</span>
                                <span id="reps-value" class="text-xl font-bold">0</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm opacity-80">Session Duration</span>
                                <span id="duration-value" class="text-xl font-bold">00:00</span>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-3 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm opacity-80">Alerts</span>
                                <span id="alerts-value" class="text-xl font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Logs -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-file-alt mr-2"></i>Session Logs
                    </h3>
                    <div id="logs-container" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-sm">No logs available</p>
                    </div>
                    <button id="refresh-logs" class="w-full mt-4 bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-lg transition">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-gray-600">
            <p>&copy; 2024 VisionTrack - Real-Time Human Pose Estimation System</p>
            <p class="text-sm mt-1">Powered by MediaPipe & OpenCV</p>
        </div>
    </footer>

    <script>
        // Global variables
        let currentMode = 'fitness';
        let isConnected = false;

        // DOM elements
        const statusIndicator = document.getElementById('status-indicator');
        const currentModeSpan = document.getElementById('current-mode');
        const videoFeed = document.getElementById('video-feed');

        // Stats elements
        const fpsValue = document.getElementById('fps-value');
        const personsValue = document.getElementById('persons-value');
        const repsValue = document.getElementById('reps-value');
        const alertsValue = document.getElementById('alerts-value');

        // Buttons
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const saveBtn = document.getElementById('save-btn');
        const audioToggleBtn = document.getElementById('audio-toggle-btn');
        const refreshLogsBtn = document.getElementById('refresh-logs');

        // Mode buttons
        const modeButtons = document.querySelectorAll('.mode-btn');
        const exerciseButtons = document.querySelectorAll('.exercise-btn');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateStats();
            loadLogs();
            
            // Initialize exercise selection visibility
            updateModeDisplay('fitness'); // Default to fitness mode
            
            // Auto-refresh stats every 2 seconds
            setInterval(updateStats, 2000);
        });

        function setupEventListeners() {
            // Control buttons
            startBtn.addEventListener('click', () => controlAction('start'));
            stopBtn.addEventListener('click', () => controlAction('stop'));
            resetBtn.addEventListener('click', () => controlAction('reset'));
            saveBtn.addEventListener('click', saveSession);
            audioToggleBtn.addEventListener('click', toggleAudio);
            refreshLogsBtn.addEventListener('click', loadLogs);

            // Mode selection
            document.getElementById('mode-fitness').addEventListener('click', () => setMode('fitness'));
            document.getElementById('mode-surveillance').addEventListener('click', () => setMode('surveillance'));
            document.getElementById('mode-gaming').addEventListener('click', () => setMode('gaming'));
            
            // Exercise selection
            document.getElementById('exercise-squat').addEventListener('click', () => setExercise('squat'));
            document.getElementById('exercise-pushup').addEventListener('click', () => setExercise('pushup'));
            document.getElementById('exercise-bicep').addEventListener('click', () => setExercise('bicep_curl'));

            // Video feed error handling
            videoFeed.addEventListener('load', () => {
                updateConnectionStatus(true);
            });
            
            videoFeed.addEventListener('error', () => {
                updateConnectionStatus(false);
            });
        }

        async function setMode(mode) {
            try {
                const response = await fetch(`/api/mode/${mode}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    currentMode = mode;
                    updateModeUI(mode);
                    updateModeDisplay(mode);
                }
            } catch (error) {
                console.error('Error setting mode:', error);
            }
        }

        function updateModeUI(mode) {
            // Reset all mode buttons
            modeButtons.forEach(btn => {
                btn.classList.remove('mode-active');
                btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
            });

            // Activate selected mode button
            const activeBtn = document.getElementById(`mode-${mode}`);
            if (activeBtn) {
                activeBtn.classList.add('mode-active');
                activeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
            }
        }

        function updateModeDisplay(mode) {
            const modeNames = {
                'fitness': 'FITNESS MODE',
                'surveillance': 'SURVEILLANCE MODE',
                'gaming': 'GAMING MODE'
            };
            currentModeSpan.textContent = modeNames[mode] || 'UNKNOWN MODE';
            
            // Show/hide exercise selection for fitness mode
            const exerciseSelection = document.getElementById('exercise-selection');
            if (mode === 'fitness') {
                exerciseSelection.style.display = 'block';
            } else {
                exerciseSelection.style.display = 'none';
            }
        }

        async function saveSession() {
            try {
                const response = await fetch('/api/session/save', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Session saved successfully!');
                    loadLogs(); // Refresh logs
                } else {
                    alert('Error saving session: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving session:', error);
                alert('Error saving session');
            }
        }

        async function toggleAudio() {
            try {
                const response = await fetch('/api/audio/toggle', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    const icon = audioToggleBtn.querySelector('i');
                    const status = document.getElementById('audio-status');
                    
                    if (data.audio_enabled) {
                        icon.className = 'fas fa-volume-up mr-1';
                        status.textContent = 'Audio';
                        audioToggleBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition';
                    } else {
                        icon.className = 'fas fa-volume-mute mr-1';
                        status.textContent = 'Muted';
                        audioToggleBtn.className = 'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition';
                    }
                } else {
                    console.error('Error toggling audio:', data.error);
                }
            } catch (error) {
                console.error('Error toggling audio:', error);
            }
        }

        async function setExercise(exerciseType) {
            try {
                const response = await fetch(`/api/exercise/set/${exerciseType}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update UI
                    exerciseButtons.forEach(btn => {
                        btn.classList.remove('exercise-active');
                        btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
                    });
                    
                    const activeBtn = document.getElementById(`exercise-${exerciseType}`);
                    if (activeBtn) {
                        activeBtn.classList.add('exercise-active');
                        activeBtn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    }
                } else {
                    console.error('Error setting exercise type:', data.error);
                }
            } catch (error) {
                console.error('Error setting exercise type:', error);
            }
        }

        async function controlAction(action) {
            try {
                const response = await fetch(`/api/control/${action}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    console.log(`${action} action successful`);
                    if (action === 'reset') {
                        // Reset UI stats
                        repsValue.textContent = '0';
                        alertsValue.textContent = '0';
                    }
                }
            } catch (error) {
                console.error(`Error performing ${action}:`, error);
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                // Update stats display
                fpsValue.textContent = stats.fps || '0';
                document.getElementById('people-value').textContent = stats.active_people || '0';
                repsValue.textContent = stats.session_reps || '0';
                alertsValue.textContent = stats.alerts_count || '0';
                
                // Update session duration
                const duration = stats.session_duration || 0;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('duration-value').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update mode if different
                if (stats.current_mode !== currentMode) {
                    currentMode = stats.current_mode;
                    updateModeUI(currentMode);
                    updateModeDisplay(currentMode);
                }
                
                updateConnectionStatus(true);
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                
                const container = document.getElementById('logs-container');
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No logs available</p>';
                    return;
                }
                
                container.innerHTML = logs.map(log => `
                    <div class="bg-gray-50 p-3 rounded border-l-4 border-indigo-500">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-sm">${log.filename}</span>
                            <a href="/api/download/${log.filename}" 
                               class="text-indigo-600 hover:text-indigo-800 text-sm">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            ${new Date(log.modified).toLocaleString()} â€¢ ${(log.size / 1024).toFixed(1)} KB
                        </p>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const indicator = statusIndicator.querySelector('div');
            const text = statusIndicator.querySelector('span');
            
            if (connected) {
                indicator.classList.remove('bg-red-500');
                indicator.classList.add('bg-green-500');
                text.textContent = 'Connected';
            } else {
                indicator.classList.remove('bg-green-500');
                indicator.classList.add('bg-red-500');
                text.textContent = 'Disconnected';
            }
        }
    </script>
</body>
</html>